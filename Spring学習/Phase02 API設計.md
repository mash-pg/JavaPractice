# Phase 02: API 設計

> **目的**: 「何を作るか」を先に決めておく。実装中にブレないための指針を作る。

---

## 概要

| 項目 | 内容 |
|------|------|
| 設計対象 | ToDo アプリの REST API |
| 学ぶこと | REST API 設計、HTTP メソッド、ステータスコード |

---

## なぜ先に API を設計するのか

**ジュニア**: いきなりコードを書き始めちゃダメなんですか？

**シニア**: ダメではないけど、**先に設計しておく**メリットがある。

| メリット | 説明 |
|---------|------|
| **ブレない** | 実装中に「このエンドポイントどうしよう」と迷わない |
| **共有できる** | チームで「何を作るか」を共有できる |
| **テストしやすい** | 期待するレスポンスが明確だからテストを書きやすい |

---

## 2.1 REST API とは

### 質問形式で学ぶ

**ジュニア**: REST API って何ですか？

**シニア**: **HTTP を使ってデータをやり取りする仕組み**のこと。

| 用語 | 意味 |
|------|------|
| **REST** | Representational State Transfer（設計スタイルの名前） |
| **API** | Application Programming Interface（プログラム同士の接点） |

**ジュニア**: もう少し具体的に教えてください。

**シニア**: 例えば、「ToDo を作成したい」場合：

```
クライアント（ブラウザ）                サーバー（Spring Boot）
        │                                    │
        │ ── POST /api/todos ──────────────> │
        │    {"title": "買い物"}              │
        │                                    │
        │ <── 201 Created ───────────────── │
        │    {"id": 1, "title": "買い物"}     │
```

---

### HTTP メソッド

**ジュニア**: POST とか GET とか、いくつも種類があってよくわからないです。

**シニア**: **やりたいこと**によってメソッドを使い分ける。

| メソッド | 用途 | 例 |
|---------|------|-----|
| **GET** | データを取得 | ToDo 一覧を見る |
| **POST** | データを作成 | 新しい ToDo を作る |
| **PUT** | データを更新 | ToDo のタイトルを変える |
| **DELETE** | データを削除 | ToDo を消す |
| **PATCH** | データを部分更新 | 一部のフィールドだけ変更 |

**ジュニア**: PUT と PATCH の違いは？

**シニア**:

| メソッド | 違い |
|---------|------|
| **PUT** | リソース全体を置き換え |
| **PATCH** | 一部のフィールドだけ更新 |

今回のアプリでは **PUT** を使う。シンプルだから。

---

### リソースとエンドポイント

**ジュニア**: `/api/todos` の `/todos` って何ですか？

**シニア**: これは**リソース**の名前。「ToDo というデータの集まり」を表している。

| 用語 | 意味 | 例 |
|------|------|-----|
| **リソース** | 操作対象のデータ | ToDo、ユーザー、商品 |
| **エンドポイント** | リソースにアクセスする URL | `/api/todos` |

**命名のルール:**

| ルール | 例 |
|--------|-----|
| **複数形を使う** | `/todos`（○） `/todo`（△） |
| **小文字を使う** | `/todos`（○） `/Todos`（×） |
| **ケバブケース** | `/user-profiles`（○） `/userProfiles`（△） |

---

## 2.2 ToDo API のエンドポイント設計

### エンドポイント一覧

**シニア**: ToDo アプリで必要な API を設計しよう。

| メソッド | エンドポイント | 説明 | ステータス |
|---------|---------------|------|-----------|
| `POST` | `/api/todos` | ToDo を作成 | 201 |
| `GET` | `/api/todos` | ToDo 一覧を取得 | 200 |
| `GET` | `/api/todos/{id}` | ToDo 詳細を取得 | 200 |
| `PUT` | `/api/todos/{id}` | ToDo を更新 | 200 |
| `DELETE` | `/api/todos/{id}` | ToDo を削除 | 204 |
| `POST` | `/api/todos/{id}/complete` | ToDo を完了にする | 200 |

**ジュニア**: `{id}` って何ですか？

**シニア**: **パスパラメータ**といって、URL の一部に ID を埋め込む書き方。

```
GET /api/todos/1    → ID が 1 の ToDo を取得
GET /api/todos/42   → ID が 42 の ToDo を取得
```

---

### 詰まったところ

#### Q: 完了はなぜ PUT ではなく POST？

**ジュニア**: 完了にするのは「更新」だから PUT じゃないんですか？

**シニア**: 良い質問。2つの考え方がある。

| 方法 | エンドポイント | 考え方 |
|------|---------------|--------|
| **方法1** | `PUT /api/todos/{id}` + body に `{"status": "DONE"}` | 汎用的な更新 |
| **方法2** | `POST /api/todos/{id}/complete` | 「完了する」という**アクション** |

今回は**方法2**を採用。理由は：

| 理由 | 説明 |
|------|------|
| **意図が明確** | 「完了する」というビジネス操作が URL から読み取れる |
| **バリデーションしやすい** | 「既に完了している」などのルールを適用しやすい |

**ジュニア**: なるほど、「更新」と「完了」は別の操作として扱うんですね。

---

## 2.3 HTTP ステータスコード

### よく使うステータスコード

**ジュニア**: ステータスコードって何ですか？

**シニア**: サーバーからクライアントへの「結果報告」。数字で表す。

| 範囲 | 意味 | 例 |
|------|------|-----|
| **2xx** | 成功 | 200 OK, 201 Created |
| **4xx** | クライアントのエラー | 400 Bad Request, 404 Not Found |
| **5xx** | サーバーのエラー | 500 Internal Server Error |

---

### ToDo API で使うステータスコード

| コード | 意味 | 使う場面 |
|--------|------|---------|
| `200` | OK | 取得・更新成功 |
| `201` | Created | 作成成功 |
| `204` | No Content | 削除成功（レスポンスボディなし） |
| `400` | Bad Request | バリデーションエラー |
| `404` | Not Found | リソースが存在しない |
| `409` | Conflict | ビジネスルール違反 |

---

### 詰まったところ

#### Q: 200 と 201 の使い分け

**ジュニア**: 成功したら全部 200 じゃダメですか？

**シニア**: 動くけど、**201 を使う方が親切**。

| コード | 意味 | いつ使う？ |
|--------|------|-----------|
| `200 OK` | 成功（汎用） | GET, PUT で成功 |
| `201 Created` | 作成成功 | POST で新しいリソースを作成 |

**201 のメリット:**
- クライアントが「新しく作成された」と明確にわかる
- REST API の慣習に沿っている

---

#### Q: 204 No Content とは

**ジュニア**: 削除したら何を返せばいいですか？

**シニア**: **204 No Content** を返す。

```
DELETE /api/todos/1

レスポンス:
HTTP/1.1 204 No Content
（ボディなし）
```

**ジュニア**: なぜボディを返さないんですか？

**シニア**: 削除したものを返しても意味がないから。「消えました」という事実だけ伝えれば十分。

---

#### Q: 409 Conflict はいつ使う？

**ジュニア**: 400 Bad Request と 409 Conflict の違いは？

**シニア**:

| コード | 意味 | 例 |
|--------|------|-----|
| `400` | リクエストの形式がおかしい | タイトルが空、文字数オーバー |
| `409` | ビジネスルール違反 | 既に完了した ToDo を再度完了しようとした |

**400**: 「お前のリクエストがおかしい」
**409**: 「リクエストは正しいけど、今の状態では実行できない」

---

## 2.4 リクエスト/レスポンスの設計

### リクエストボディ

**ジュニア**: リクエストでどんなデータを送ればいいですか？

**シニア**: 操作によって違う。

**POST /api/todos（作成）:**
```json
{
  "title": "買い物に行く"
}
```

**PUT /api/todos/{id}（更新）:**
```json
{
  "title": "買い物に行く（更新）"
}
```

---

### レスポンスボディ

**GET /api/todos（一覧）:**
```json
[
  {
    "id": 1,
    "title": "買い物に行く",
    "status": "OPEN",
    "priority": "LOW",
    "createdAt": "2026-02-02T10:00:00"
  },
  {
    "id": 2,
    "title": "レポートを書く",
    "status": "DONE",
    "priority": "HIGH",
    "createdAt": "2026-02-01T09:00:00"
  }
]
```

**GET /api/todos/{id}（詳細）:**
```json
{
  "id": 1,
  "title": "買い物に行く",
  "status": "OPEN",
  "priority": "LOW",
  "description": "牛乳と卵を買う",
  "dueDate": "2026-02-03",
  "createdAt": "2026-02-02T10:00:00",
  "updatedAt": null
}
```

**エラーレスポンス:**
```json
{
  "error": "Bad Request",
  "message": "title: 空白は許可されていません"
}
```

---

## 2.5 DTO（Data Transfer Object）

### なぜ DTO を使うのか

**ジュニア**: レスポンスで Entity をそのまま返しちゃダメですか？

**シニア**: ダメではないけど、**DTO を使う方がベター**。

| 項目 | Entity をそのまま返す | DTO を使う |
|------|---------------------|-----------|
| 簡単さ | ○ 楽 | △ 変換が必要 |
| 安全性 | × パスワードなど漏れる可能性 | ○ 必要なものだけ返せる |
| 柔軟性 | × DB 構造に依存 | ○ API の都合で形式を変えられる |

**ジュニア**: Entity と DTO の違いがわからないです。

**シニア**: 責務が違う。

| 種類 | 責務 | 例 |
|------|------|-----|
| **Entity** | DB に何を保存するか | `Todo` クラス |
| **DTO** | API で何をやり取りするか | `TodoResponse`, `CreateTodoRequest` |

---

### DTO の種類

| クラス名 | 用途 |
|---------|------|
| `CreateTodoRequest` | 作成リクエスト |
| `UpdateTodoRequest` | 更新リクエスト |
| `TodoResponse` | レスポンス |
| `ErrorResponse` | エラーレスポンス |

---

## 2.6 設計ルール

### 今回採用するルール

| ルール | 理由 |
|--------|------|
| エンドポイントは複数形 | `/todos`（RESTの慣習） |
| リクエストは DTO | Entity を直接受け取らない |
| レスポンスは DTO | Entity を直接返さない |
| 作成は 201 | 新規作成を明示 |
| 削除は 204 | ボディなしで返す |
| ビジネスエラーは 409 | 400 と区別する |

---

## まとめ

### HTTP メソッド

| メソッド | 用途 |
|---------|------|
| GET | 取得 |
| POST | 作成 |
| PUT | 更新 |
| DELETE | 削除 |

### ステータスコード

| コード | 意味 |
|--------|------|
| 200 | 成功 |
| 201 | 作成成功 |
| 204 | 削除成功（ボディなし） |
| 400 | バリデーションエラー |
| 404 | リソースなし |
| 409 | ビジネスルール違反 |

### 設計ポイント

| ポイント | 内容 |
|---------|------|
| 先に設計 | 実装前にエンドポイントを決める |
| DTO 使用 | Entity を直接やり取りしない |
| 意図が明確な URL | `/complete` のようなアクション |

---

## チェックリスト

- [x] REST API の基本を理解
- [x] HTTP メソッドの使い分けを理解
- [x] ステータスコードの使い分けを理解
- [x] エンドポイント一覧を設計
- [x] リクエスト/レスポンスの形式を設計
- [x] DTO を使う理由を理解

---

## 次のステップ

- [ ] Phase 03: レイヤ設計 へ進む

---

*このドキュメントは学習中に詰まった点と解決方法を記録したものです。*
